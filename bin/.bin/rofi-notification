#!/usr/bin/env bash
# -*- mode: sh; -*-

DIR="$HOME/.cache/dunst"
file="$DIR/dunst.log"


function get-entries() {
    while read -r line; do

        APP=$(awk -F";;" '{print $1}' <<<"$line")
        ICON_NAME=$(echo "$APP" | awk '{ gsub(/ /,""); print tolower($0) }')
        TITLE=$(awk -F";;" '{print $2}' <<<"$line")
        DESC=$(awk -F";;" '{print $3}' <<<"$line")
        ICON=$(fd -c never "$ICON_NAME" /usr/share/icons | grep apps | head -1)
        if [ "$ICON" == "" ]; then
            ICON=$(fd -1 -c never "$ICON_NAME" /usr/share/pixmaps)
        fi

        echo -en "$APP : $TITLE : $DESC \x00icon\x1f$ICON\n"
    done <"$file"
}

while true ; do

    ITEM=$(get-entries |
        rofi -dmenu -multi-select -p "Notification " -config ~/.config/rofi/notification.rasi -show-icons)

    if [ "$ITEM" == "" ]; then
        exit 0
    fi

    OUT=$(echo "$ITEM" | awk -F' : ' '{printf("%s;;%s;;%s\n",$1,$2,$3)}')
    if [ "$OUT" == ";;;;" ]; then
        continue
    fi

    while read -r line; do
        line=${line//\//\\/}
        echo $line
        sed -i -e "s|^$line$||g" $file
    done <<<"$OUT"

    sed -i -r '/^\s*$/d' $file
    sed -i -r '/\D+%\s*$/d' $file
done
